"use strict";var VLS_GF=VLS_GF||{};VLS_GF.GalleryManager=function(e){function t(){d=e("#vls-gf-tab-panel"),f=e(".vls-gf-tab-view"),d.find("ul > li > a").on("click.vls-gf",function(t){l(e(this).attr("href")),t.preventDefault()}),VLS_GF.NavigationPanelModule.init(),a(v.itemType,v.albumId)}function a(t,a,s,i){return"all_images"==t||"unsorted_images"==t?(a=0,e("#vls-gf-tab-panel").slideUp(),"all_images"==t?s=vlsGfGalleryAdminData.l10n.strAllImages:"unsorted_images"==t&&(s=vlsGfGalleryAdminData.l10n.strUnsortedImages),e(".vls-gf-window-title > .vls-gf-shortcode").css("display","none").find("input").val("")):(e("#vls-gf-tab-panel").slideDown(),e(".vls-gf-window-title .vls-gf-shortcode").css("display","").find("input").val(i)),e(".vls-gf-window-title > span").first().text(s),v.itemType=t,v.albumId=a,v.tab="album_overview",l(v.tab),!1}function l(e){switch(e=e.replace("#",""),f.append('<div class="vls-gf-loading-overlay"><span></span></div>'),d.find("li").removeClass("active"),d.find('a[href="#'+e+'"]:first').parent().addClass("active"),e){case"album_overview":VLS_GF.AlbumOverviewPanelModule.loadContent(v.itemType,v.albumId);break;case"album_layout":VLS_GF.AlbumLayoutPanelModule.loadContent(v.albumId);break;case"album_edit":VLS_GF.ItemEditPanelModule.loadContent("album",v.albumId);break;default:return!1}return!1}function s(){l(v.tab)}function i(){return e('<div class="vls-gf-modal"><div class="vls-gf-backdrop"></div><div class="vls-gf-window"></div></div>')}function n(){e(".vls-gf-modal").remove()}function r(t,a,l,s){var r=i(),o=r.find(".vls-gf-window");o.append('<div class="vls-gf-title"><span>'+t+"</span></div>");var d=e('<div class="vls-gf-content"></div>');o.append(d),d.append('<span class="vls-gf-message">'+a+"</span>");var f=e('<div class="vls-gf-buttons-panel"></div>');o.append(f);var v=e('<a class="button" href="#">Cancel</a>');v.on("click.vls-gf",n),f.append(v);var g=e('<a class="button-primary" href="#"></a>').text(l);g.on("click.vls-gf",s),f.append(g),e("#wpwrap").append(r),o.css("margin-top",0-o.height()/2)}function o(t,a){var l="",s="",r="";"rename"===t?(l=vlsGfGalleryAdminData.l10n.strRenameHeader,s=vlsGfGalleryAdminData.l10n.strRenameAction,r=vlsGfGalleryAdminData.l10n.strRenameLabel):"createFolder"===t?(l=vlsGfGalleryAdminData.l10n.strCreateFolderHeader,s=vlsGfGalleryAdminData.l10n.strCreateFolderAction,r=vlsGfGalleryAdminData.l10n.strCreateFolderLabel):"createAlbum"===t&&(l=vlsGfGalleryAdminData.l10n.strCreateAlbumHeader,s=vlsGfGalleryAdminData.l10n.strCreateAlbumAction,r=vlsGfGalleryAdminData.l10n.strCreateAlbumLabel);var o=i(),d=o.find(".vls-gf-window");d.append('<div class="vls-gf-title"><span>'+l+"</span></div>");var f=e('<div class="vls-gf-content"></div>');d.append(f),f.append('<label class="vls-gf-form-element"><span>'+r+'</span><input type="text" value="" /></label>');var v=f.find("input");v.on("keyup.vls-gf",function(e){13==e.keyCode&&a()});var g=e('<div class="vls-gf-buttons-panel"></div>');d.append(g);var c=e('<a class="button" href="#">'+vlsGfGalleryAdminData.l10n.btnCancel+"</a>");c.on("click.vls-gf",n),g.append(c);var p=e('<a class="button-primary" href="#"></a>').text(s);p.on("click.vls-gf",a),g.append(p),e("#wpwrap").append(o),d.css("margin-top",0-d.height()/2),v.focus()}var d,f,v={itemType:"unsorted_images",albumId:0,tab:"album_overview"};return{init:t,switchAlbum:a,reloadTab:s,showConfirmDialog:r,showNameDialog:o,closePopup:n}}(jQuery),VLS_GF.NavigationPanelModule=function(e){function t(){w=e(".vls-gf-gallery-manager-container .vls-gf-navigation-panel"),y=e("#vls-gf-gallery-tree"),w.find("ul.vls-gf-fixed-items a").on("click.vls-gf touchend.vls-gf",function(t){t.preventDefault();var a=e(this);w.find("ul>li>span.wp-ui-highlight").remove(),a.parent().append('<span class="wp-ui-highlight">');var l=a.attr("href").replace("#","");return VLS_GF.GalleryManager.switchAlbum(l,0),!1}),e("#vls-gf-btn-edit-gallery-tree").on("click.vls-gf touchend.vls-gf",h),e("#vls-gf-btn-gallery-tree-commit, #vls-gf-btn-gallery-tree-cancel").on("click.vls-gf touchend.vls-gf",m),e("#vls-gf-btn-add-new-folder").on("click.vls-gf touchend.vls-gf",g),e("#vls-gf-btn-add-new-album").on("click.vls-gf touchend.vls-gf",c),l()}function a(){y.find("li").on("click.vls-gf touchend.vls-gf",f),s(),y.parent().find("li.vls-gf-unsorted, li.vls-gf-album").droppable({accept:".dragging-image",hoverClass:"drop-ready",drop:G})}function l(){e.get(ajaxurl,{action:"vls_gf_view_gallery_tree",tour:VLS_GF.TourModule&&VLS_GF.TourModule.isActive()},function(e){y.empty().append(e),a()},"html")}function s(){C.nextItemOrder=99999;var t=0,a=100,l=!1,s=1,i=1,n=0,r=y.find("li").not(".vls-gf-deleted");r.sort(function(t,a){return parseInt(e(t).data("vlsGfOrder"))-parseInt(e(a).data("vlsGfOrder"))});for(var o=0;o<r.length;++o){var d=e(r[o]),f=parseInt(d.data("vlsGfLevel"));f>a?(d.addClass("vls-hidden"),d.css({position:"absolute",top:(t-1)*I.height+"px"}),d.data("vlsGfPosition",t-1).attr("data-vls-gf-position",t-1)):(++n,a=100,d.removeClass("vls-hidden"),d.hasClass("vls-gf-folder")&&!d.hasClass("opened")&&(a=parseInt(d.data("vlsGfLevel"))),C.ghostPosition==t&&++t,d.hasClass("ui-draggable-dragging")||(d.css({top:t*I.height+"px"}),d.data("vlsGfPosition",t).attr("data-vls-gf-position",t),t==C.ghostPosition-1?(l=d.hasClass("vls-gf-folder"),s=f):t==C.ghostPosition+1&&(i=f,C.nextItemOrder=parseInt(d.data("vlsGfOrder"))),++t))}C.$draggedItem&&(C.ghostLevel=C.ghostLevel+C.initialLevel,s>=i?(l&&(s+=1,s>7&&(s=7)),C.ghostLevel>s?C.ghostLevel=s:C.ghostLevel<i&&(C.ghostLevel=i)):C.ghostLevel=i,C.ghostPosition>=n&&(C.ghostPosition=n-1),C.$draggingGhost.css("top",C.ghostPosition*I.height+"px"),C.$draggingGhost.attr("class","dragging-ghost"),C.$draggingGhost.addClass("level-"+C.ghostLevel)),y.css("height",28*n+"px")}function i(e,t){e.hasClass("opened")&&"open"!=t?(e.removeClass("opened"),s()):e.hasClass("opened")||"close"==t||(e.addClass("opened"),s())}function n(t,a){var l=e(this);C.itemTreeOffset={top:y.offset().top,left:y.offset().left},l.removeClass("opened"),y.find("li").draggable("disable"),C.$draggedItem=l,C.ghostPosition=Math.floor((l.offset().top-C.itemTreeOffset.top+I.middle)/I.height),C.initialLevel=parseInt(l.data("vlsGfLevel"));var i=y.find("li");i.sort(function(t,a){return parseInt(e(t).data("vlsGfOrder"))-parseInt(e(a).data("vlsGfOrder"))});for(var n=!1,r=!1,o=0;o<i.length;++o){var d=e(i[o]),f=(parseInt(d.data("vlsGfId")),parseInt(d.data("vlsGfOrder"))),v=parseInt(d.data("vlsGfLevel")),g=(parseInt(l.data("vlsGfId")),parseInt(l.data("vlsGfOrder")));d.is(l)?n=!0:f>g&&v<=C.initialLevel&&!r?r=!0:f>g&&v>C.initialLevel&&!r&&d.addClass("vls-gf-dragging-child")}y.append(C.$draggingGhost),s()}function r(t,a){var l=parseInt(a.offset.top)+I.middle;if(!(l>=C.currentArea.top&&l<=C.currentArea.bottom&&a.offset.left>=C.currentArea.left&&a.offset.left<=C.currentArea.right)){clearTimeout(C.hoverTimeout);var n=Math.floor((l-C.itemTreeOffset.top)/I.height);0>n&&(n=0),C.ghostLevel=Math.floor((parseInt(a.offset.left)-C.itemTreeOffset.left)/_),C.currentArea.left=C.itemTreeOffset.left+C.ghostLevel*_,C.currentArea.right=C.itemTreeOffset.left+(C.ghostLevel+1)*_-1;var r=C.itemTreeOffset.top+I.height*n,o=l-r+1,d=y.find("li").filter(function(t,a){var l=e(a);return l.data("vlsGfPosition")==n&&!l.hasClass("vls-hidden")&&!l.hasClass("ui-draggable-dragging")});d&&d.hasClass("vls-gf-folder")&&!d.hasClass("opened")?n>C.ghostPosition&&o>I.bottomPart?(C.ghostPosition=n,C.currentArea.top=r,C.currentArea.bottom=r+I.height-1):n<C.ghostPosition&&o<=I.topPart?(C.ghostPosition=n,C.currentArea.top=r,C.currentArea.bottom=r+I.height-1):(n>C.ghostPosition?(C.currentArea.top=r,C.currentArea.bottom=r+I.bottomPart):(C.currentArea.top=r+I.topPart,C.currentArea.bottom=r+I.height-1),C.hoverTimeout=setTimeout(function(){i(d,"open")},500)):(C.ghostPosition=n,C.currentArea.top=r,C.currentArea.bottom=r+I.height-1),s()}}function o(){var t=e(this);return t.addClass("ui-draggable-placing"),setTimeout(function(){t.removeClass("ui-draggable-placing")},550),!1}function d(t,a){var l=!1,i=e(this),n=y.find("li").not(".vls-gf-dragging-child, .ui-draggable-dragging");n.sort(function(t,a){var l=e(t),s=e(a);return 1e5*parseInt(l.data("vlsGfPosition"))+parseInt(l.data("vlsGfOrder"))-1e5*parseInt(s.data("vlsGfPosition"))-parseInt(s.data("vlsGfOrder"))});var r=y.find("li.vls-gf-dragging-child");r.sort(function(t,a){return parseInt(e(t).data("vlsGfOrder"))-parseInt(e(a).data("vlsGfOrder"))});for(var o=0,d=0;d<=n.length;++d){if(d<n.length)var f=e(n[d]);if(++o,!l&&(d==n.length&&99999==C.nextItemOrder||f.hasClass("vls-gf-deleted")||d<n.length&&C.nextItemOrder==parseInt(f.data("vlsGfOrder")))){l=!0,i.data("vlsGfOrder",o).attr("data-vls-gf-order",o),++o;for(var v=0;v<r.length;++v){var g=e(r[v]),c=parseInt(g.data("vlsGfLevel"))+C.ghostLevel-C.initialLevel;c=c>7?7:c,g.data("vlsGfOrder",o).attr("data-vls-gf-order",o).data("vlsGfLevel",c).attr("data-vls-gf-level",c).data("vlsGfPosition",c).attr("data-vls-gf-position",C.ghostPosition).removeClass("level-1 level-2 level-3 level-4 level-5 level-6 level-7").addClass("level-"+c).css("top",C.$draggingGhost.css("top")),++o}}d<n.length&&f.data("vlsGfOrder",o).attr("data-vls-gf-order",o)}i.css({left:"0px",top:C.$draggingGhost.css("top")}).removeClass("ui-draggable-dragging level-1 level-2 level-3 level-4 level-5 level-6 level-7").addClass("level-"+C.ghostLevel).data("vlsGfPosition",C.ghostPosition).attr("data-vls-gf-position",C.ghostPosition).data("vlsGfLevel",C.ghostLevel).attr("data-vls-gf-level",C.ghostLevel),y.find("li").removeClass("vls-gf-dragging-child").draggable("enable"),C.$draggedItem=null,C.ghostPosition=-1,C.items=[],C.$draggingGhost.remove(),s()}function f(){var t=e(this);return t.hasClass("ui-draggable-dragging")||t.hasClass("ui-draggable-placing")||(t.hasClass("vls-gf-folder")?i(t):t.hasClass("vls-gf-album")&&!S&&t.data("vlsGfId")>0&&(w.find(".wp-ui-highlight").remove(),t.append('<span class="wp-ui-highlight">'),VLS_GF.GalleryManager.switchAlbum("album",t.data("vlsGfId"),t.find(".vls-gf-label").text(),t.data("vlsGfShortcode")))),!1}function v(t){var a=e(this).closest("li");return VLS_GF.GalleryManager.showNameDialog("rename",function(){var t=e(".vls-gf-modal").first().find("input").val();t&&""!=t?(a.find(".vls-gf-label").text(t),a.data("vlsGfIsRenamed","true").attr("data-vls-gf-is-renamed","true"),VLS_GF.GalleryManager.closePopup()):alert("Name must be entered")}),!1}function g(e){return p("folder"),!1}function c(e){return p("album"),!1}function p(t){var a="";if("folder"==t)a="createFolder";else{if("album"!=t)return;a="createAlbum"}VLS_GF.GalleryManager.showNameDialog(a,function(){var a=e(".vls-gf-modal").first().find("input").val();if(a&&""!=a){var l=y.find("li"),i=0;l.length>0&&(i=parseInt(l.sort(function(t,a){return parseInt(e(t).data("vlsGfOrder"))-parseInt(e(a).data("vlsGfOrder"))}).last().data("vlsGfOrder")));var n=e('<li class="vls-gf-'+t+' level-1"><a href="#"><span class="vls-gf-icon"></span><span class="vls-gf-label">'+a+'</span></a><span class="btn btn-delete"></span><span class="btn btn-rename"></span></li>');n.data("vlsGfId",0).attr("data-vls-gf-id",0).data("vlsGfLevel",1).attr("data-vls-gf-level",1).data("vlsGfOrder",i+1).attr("data-vls-gf-order",i+1).data("vlsGfPosition",99999).attr("data-vls-gf-position",99999).data("vlsGfIsAdded","true").attr("data-vls-gf-is-added","true").css("top",y.height()-28+"px"),y.append(n),n.bind("click.vls-gf",f),n.find(".btn-rename").on("click.vls-gf touchend.vls-gf",v),n.find(".btn-delete").on("click.vls-gf touchend.vls-gf",u),b(),s(),VLS_GF.GalleryManager.closePopup()}else alert("Name must be entered")})}function u(){var t="",a=e(this).closest("li");return t=a.hasClass("vls-gf-album")?vlsGfGalleryAdminData.l10n.strConfirmDeleteAlbumMessage.replace("%1$s",a.find(".vls-gf-label").text()):vlsGfGalleryAdminData.l10n.strConfirmDeleteFolderMessage.replace("%1$s",a.find(".vls-gf-label").text()),VLS_GF.GalleryManager.showConfirmDialog(vlsGfGalleryAdminData.l10n.strConfirmDeleteHeader,t,vlsGfGalleryAdminData.l10n.strDeleteFolderAction,function(){var t=0;return y.find("li").not(".vls-gf-deleted").sort(function(t,a){return parseInt(e(t).data("vlsGfOrder"))-parseInt(e(a).data("vlsGfOrder"))}).each(function(){var l=e(this);if(l.is(a))t=parseInt(l.data("vlsGfLevel"));else if(t>0){var s=parseInt(l.data("vlsGfLevel"));if(!(s>t))return!1;l.addClass("vls-gf-deleted").data("vlsGfLevel",s-t+1).attr("data-vls-gf-level",s-t+1).data("vlsGfPosition",99999).attr("data-vls-gf-position",99999)}}),a.addClass("vls-gf-deleted").data("vlsGfLevel",1).attr("data-vls-gf-level",1).data("vlsGfIsDeleted","true").attr("data-vls-gf-is-deleted","true").data("vlsGfPosition",99999).attr("data-vls-gf-position",99999),s(),VLS_GF.GalleryManager.closePopup(),!1}),!1}function h(t){if(y.find(".vls-gf-loading-overlay").length>0)return!1;S=!0,w.addClass("vls-gf-edit-mode"),e(this).css("display","none"),e("#vls-gf-panel-edit-gallery-tree").css("display","block");var a=y.find("li");a.append('<span class="btn btn-delete"></span><span class="btn btn-rename"></span>'),a.find(".btn-rename").on("click.vls-gf touchend.vls-gf",v),a.find(".btn-delete").on("click.vls-gf touchend.vls-gf",u),b(),t.preventDefault()}function m(t){if(y.find("li").draggable("destroy").find(".btn").remove(),e("#vls-gf-panel-edit-gallery-tree").css("display","none"),e("#vls-gf-btn-edit-gallery-tree").css("display","block"),y.append('<div class="vls-gf-loading-overlay"><span></span></div>'),S=!1,w.removeClass("vls-gf-edit-mode"),"vls-gf-btn-gallery-tree-commit"==t.target.id){var a=[];y.find("li").each(function(){var t=e(this),l="",s="",i="",n="",r="";t.data("vlsGfIsAdded")&&(i=t.data("vlsGfIsAdded")),t.data("vlsGfIsRenamed")&&(n=t.data("vlsGfIsRenamed")),t.data("vlsGfIsDeleted")&&(r=t.data("vlsGfIsDeleted")),i&&(s=t.hasClass("vls-gf-album")?"album":"folder"),(i||n)&&(l=t.find(".vls-gf-label").text()),a.push({id:parseInt(t.data("vlsGfId")),type:s,order:parseInt(t.data("vlsGfOrder")),level:parseInt(t.data("vlsGfLevel")),name:l,is_added:i,is_renamed:n,is_deleted:r})}),e.post(ajaxurl,{action:"vls_gf_commit_gallery_tree_changes",security:vlsGfGalleryAdminData.nonce,itemData:JSON.stringify(a)},function(e){l()},"json")}else l();return!1}function b(){y.find("li").draggable({distance:2,addClasses:!1,cursor:"move",cancel:".btn",start:n,drag:r,revert:o,stop:d})}function G(t,a){var l,s=a.helper.data("sourceAlbum");l=e(t.target).hasClass("vls-gf-unsorted")?0:parseInt(e(t.target).data("vlsGfId"));var i=a.helper.data("draggedImages");s!==l&&e.post(ajaxurl,{action:"vls_gf_move_images_to_album",security:vlsGfGalleryAdminData.nonce,images:JSON.stringify(i),source_album:s,target_album:l},VLS_GF.GalleryManager.reloadTab)}var w,y,S=!1,C={$draggedItem:null,$draggingGhost:e('<div class="dragging-ghost"><div></div></div>'),itemTreeOffset:{top:0,bottom:0},currentArea:{top:0,bottom:0,left:0,right:0},initialLevel:0,nextItemOrder:99999,hoverTimeout:{},ghostPosition:-1,ghostLevel:0},I={height:28,middle:14,topPart:11,bottomPart:18},_=10;return{init:t,loadGalleryTree:l}}(jQuery),VLS_GF.AlbumOverviewPanelModule=function(e){function t(t,l){n=l,e.get(ajaxurl,{action:"vls_gf_view_album_overview",item_type:t,album_id:l,tour:VLS_GF.TourModule&&VLS_GF.TourModule.isActive()},a,"html")}function a(t){e(".vls-gf-tab-view").empty().append(t),r=e(".vls-gf-tab-view .vls-gf-image-panel");var a={thumb_width:140,thumb_height:140,sortable:!0,dragdrop:!0,views:{list:!1,thumbs:!0,active:"thumbs"},multipart_params:{action:"vls_gf_async_upload",album_id:n},flash_swf_url:"/plupload/js/Moxie.swf",silverlight_xap_url:"/plupload/js/Moxie.xap",stop:function(){VLS_GF.GalleryManager.reloadTab()},complete:function(){VLS_GF.GalleryManager.reloadTab()}},d={action:"vls_gf_async_upload",album_id:n};e.extend(d,vls_plupload_setup_object.multipart_params),e.extend(a,vls_plupload_setup_object),a.multipart_params=d,e("#vls-gf-upload-panel").plupload(a),e("#vls-gf-upload-image-button").on("click.vls-gf",function(t){e(".vls-gf-toolbar").slideUp(),e("#vls-gf-upload-panel").slideDown(),t.preventDefault()}),e("#vls-gf-upload-panel .plupload_cancel").on("click.vls-gf",function(t){e("#vls-gf-upload-panel").slideUp(),e(".vls-gf-toolbar").slideDown()}),e("#vls-gf-bulk-select-start-button").on("click.vls-gf",function(t){r.addClass("select-mode"),e("#vls-gf-toolbar-image-overview").fadeOut(),e("#vls-gf-toolbar-bulk-select-left").fadeIn(),e("#vls-gf-toolbar-bulk-select-right").fadeIn(),t.preventDefault()}),e("#vls-gf-bulk-select-cancel-button").on("click.vls-gf",function(t){r.removeClass("select-mode"),r.find("li").removeClass("selected").find(".image-icon").remove(),e("#vls-gf-toolbar-image-overview").fadeIn(),e("#vls-gf-toolbar-bulk-select-left").fadeOut(),e("#vls-gf-toolbar-bulk-select-right").fadeOut(),o=null,t.preventDefault()}),e("#vls-gf-bulk-select-delete-button").on("click.vls-gf",function(t){var a=[];r.find("li.selected").each(function(){a.push(parseInt(e(this).data("vlsGfImageId")))}),e.post(ajaxurl,{action:"vls_gf_delete_images",images:a,album:n},VLS_GF.GalleryManager.reloadTab),o=null,t.preventDefault()}),e("#vls-gf-bulk-select-all-button").on("click.vls-gf",function(t){e(".vls-gf-tab-view .vls-gf-image-panel li").not(".selected").addClass("selected").append('<div class="image-icon"><span></span></div>'),o=null,t.preventDefault()}),e("#vls-gf-bulk-select-none-button").on("click.vls-gf",function(t){e(".vls-gf-tab-view .vls-gf-image-panel li.selected").removeClass("selected").find(".image-icon").remove(),o=null,t.preventDefault()}),e("#vls-gf-bulk-select-invert-button").on("click.vls-gf",function(t){e(".vls-gf-tab-view .vls-gf-image-panel li").each(function(){var t=e(this);t.hasClass("selected")?t.removeClass("selected").find(".image-icon").remove():t.addClass("selected").append('<div class="image-icon"><span></span></div>')}),o=null,t.preventDefault()}),r.find("li").on("click.vls-gf",function(t){var a=e(this),l=a.data("vlsGfImageId"),s=a.data("vlsGfLinkId");if(s=s?s:0,r.hasClass("select-mode")){if(t.shiftKey&&o){var i=r.find("li").index(o),n=i,d=r.find("li").index(a);n>d&&(n=d,d=i);var f=o.hasClass("selected")?"select":"deselect";r.find("li").each(function(){var t=e(this),a=r.find("li").index(t);a>=n&&d>=a&&("select"===f?t.addClass("selected").append('<div class="image-icon"><span></span></div>'):"deselect"===f&&t.removeClass("selected").find(".image-icon").remove())})}else a.hasClass("selected")?a.removeClass("selected").find(".image-icon").remove():a.addClass("selected").append('<div class="image-icon"><span></span></div>');o=a}else{var v=[],g=[];r.find("li").each(function(){v.push(parseInt(e(this).data("vlsGfImageId")));var t=e(this).data("vlsGfLinkId");g.push(parseInt(void 0==t?0:t))}),VLS_GF.ImageDetailsModule.showImageDetailsDialog(l,s,v,g)}t.preventDefault()}),r.find("li").draggable({delay:100,cursor:"none",helper:l,cursorAt:{top:20,left:20},appendTo:"body",addClasses:!1,start:s,stop:i}),e().vlsGfLazyload&&r.find("img[data-original]").vlsGfLazyload({threshold:300,effect:"fadeIn"})}function l(){r.hasClass("select-mode")||e(this).addClass("selected");var t=[];r.find("li.selected").each(function(){t.push(parseInt(e(this).data("vlsGfImageId")))});var a=e('<div id="vls-gf-image-drag-helper">'+t.length+"</div>");return a.data("draggedImages",t),a.data("sourceAlbum",n),a}function s(){e(".vls-gf-gallery-manager-container .vls-gf-navigation-panel").addClass("drop-ready"),e(this).addClass("dragging-image")}function i(){e(".vls-gf-gallery-manager-container .vls-gf-navigation-panel").removeClass("drop-ready"),e(this).removeClass("dragging-image"),r.hasClass("select-mode")||e(this).removeClass("selected")}var n,r,o;return{loadContent:t}}(jQuery),VLS_GF.AlbumLayoutPanelModule=function(e){function t(t){h=t,e.getJSON(ajaxurl,{action:"vls_gf_view_album_layout",album_id:h,tour:VLS_GF.TourModule&&VLS_GF.TourModule.isActive()},a)}function a(t){S.layoutType="",m=e(".vls-gf-tab-view").first(),m.empty().append(t.view),b=m.find(".vls-gf-tab-container-layout > div"),G=m.find(".vls-gf-tab-container-side form"),m.find(".vls-gf-x-1-1").on("click.vls-gf",function(e){l(1),e.preventDefault()}),m.find(".vls-gf-x-1-2").on("click.vls-gf",function(e){l(.5),e.preventDefault()}),m.find(".vls-gf-x-1-4").on("click.vls-gf",function(e){l(.25),e.preventDefault()}),m.find(".vls-gf-btn-save-layout").on("click.vls-gf",function(e){p(),e.preventDefault()}),G.find("input, select").on("change.vls-gf",function(){s(),l(0)}),s(),l(1),b.find("li").draggable({containment:b,scroll:!0,cursor:"move",addClasses:!1,start:n,drag:r,stop:function(t,a){C.fadeOut(500,function(){e(this).detach()}),w.editedItem=null,u(),v()}}).append('<span class="vls-gf-resize-helper"></span><span class="vls-gf-resize-helper"></span><span class="vls-gf-resize-helper"></span><span class="vls-gf-resize-helper"></span><span class="vls-gf-resize-helper"></span><span class="vls-gf-resize-helper"></span><span class="vls-gf-resize-helper"></span><span class="vls-gf-resize-helper"></span>')}function l(e){e>0&&(y.zoom=e),m.find(".vls-gf-x-1-1").removeClass("vls-gf-active"),m.find(".vls-gf-x-1-2").removeClass("vls-gf-active"),m.find(".vls-gf-x-1-4").removeClass("vls-gf-active"),y.viewportWidth=Math.round(b.parent().width()*y.zoom),y.zoom<=.25?(b.css("width","25%"),m.find(".vls-gf-x-1-4").addClass("vls-gf-active")):y.zoom<=.5?(b.css("width","50%"),m.find(".vls-gf-x-1-2").addClass("vls-gf-active")):(b.css("width","100%"),m.find(".vls-gf-x-1-1").addClass("vls-gf-active")),y.horizontalSpacing=Math.floor(S.horizontalSpacing*y.zoom),y.verticalSpacing=Math.floor(S.verticalSpacing*y.zoom),y.cellWidth=Math.floor((y.viewportWidth-y.horizontalSpacing*(S.columnCount-1))/S.columnCount),y.cellHeight=Math.floor(y.cellWidth/S.aspectRatio),u(),v()}function s(){var e=S.layoutType;S.layoutType=G.find("#vls-gf-param-layout-type").val();var t="";"metro"==S.layoutType?(S.columnCount=parseInt(G.find("#vls-gf-param-metro-column-count").val()),t=G.find("#vls-gf-param-metro-aspect-ratio").val(),S.horizontalSpacing=parseInt(G.find("#vls-gf-param-metro-horizontal-spacing").val()),S.verticalSpacing=parseInt(G.find("#vls-gf-param-metro-vertical-spacing").val())):"grid"==S.layoutType&&(S.columnCount=parseInt(G.find("#vls-gf-param-grid-column-count").val()),t=G.find("#vls-gf-param-grid-aspect-ratio").val(),S.horizontalSpacing=parseInt(G.find("#vls-gf-param-grid-horizontal-spacing").val()),S.verticalSpacing=parseInt(G.find("#vls-gf-param-grid-vertical-spacing").val())),t=t.replace(",","."),t=t.replace(":","/"),t=t.replace("-","/");var a=t.split("/");S.aspectRatio=parseFloat(a[0]),a.length>1&&(S.aspectRatio=Math.round(S.aspectRatio/parseFloat(a[1])*1e3)/1e3),S.aspectRatio<.25&&(S.aspectRatio=.25),S.aspectRatio>4&&(S.aspectRatio=4),S.horizontalSpacing<0&&(S.horizontalSpacing=0),S.horizontalSpacing>100&&(S.horizontalSpacing=100),S.verticalSpacing<0&&(S.verticalSpacing=0),S.verticalSpacing>100&&(S.verticalSpacing=100),"grid"==S.layoutType?(G.find("#vls-gf-param-grid-horizontal-spacing").val(S.horizontalSpacing.toString()),G.find("#vls-gf-param-grid-vertical-spacing").val(S.verticalSpacing.toString()),G.find("#vls-gf-param-grid-aspect-ratio").val(S.aspectRatio.toString())):"metro"==S.layoutType&&(G.find("#vls-gf-param-metro-horizontal-spacing").val(S.horizontalSpacing.toString()),G.find("#vls-gf-param-metro-vertical-spacing").val(S.verticalSpacing.toString()),G.find("#vls-gf-param-metro-aspect-ratio").val(S.aspectRatio.toString())),e!=S.layoutType&&(b.find("li.ui-resizable").resizable("destroy"),"metro"==S.layoutType?(G.find("#vls-gf-parameters-metro").css("display","block"),G.find("#vls-gf-parameters-grid").css("display","none"),b.find("li").resizable({handles:"all",autoHide:!1,minHeight:43,minWidth:43,start:o,resize:d,stop:f})):"grid"==S.layoutType?(G.find("#vls-gf-parameters-metro").css("display","none"),G.find("#vls-gf-parameters-grid").css("display","block")):(G.find("#vls-gf-parameters-metro").css("display","none"),G.find("#vls-gf-parameters-grid").css("display","none")))}function i(e,t){return"x"+("00000"+e).slice(-5)+"y"+("00000"+t).slice(-5)}function n(t,a){var l=e(this);C.css({width:l.css("width"),height:l.css("height"),top:l.css("top"),left:l.css("left")}),b.append(C),C.fadeIn(300),l.data("vlsGfMetroW")?w.metroSize.width=parseInt(l.data("vlsGfMetroW")):w.metroSize.width=1,l.data("vlsGfMetroH")?w.metroSize.height=parseInt(l.data("vlsGfMetroH")):w.metroSize.height=1,w.centerShift={x:Math.ceil(y.cellWidth/2),y:Math.ceil(y.cellHeight/2)},w.position={x:a.position.left,y:a.position.top},w.editedItem=l,u(),r(t,a)}function r(e,t){w.position={x:t.position.left+w.centerShift.x,y:t.position.top+w.centerShift.y},(w.position.x<w.currentArea.left||w.position.x>w.currentArea.right||w.position.y<w.currentArea.top||w.position.y>w.currentArea.bottom)&&(w.currentArea.col=Math.floor(w.position.x/(y.cellWidth+y.horizontalSpacing)),w.currentArea.row=Math.floor(w.position.y/(y.cellHeight+y.verticalSpacing)),w.currentArea.left=w.currentArea.col*(y.cellWidth+y.horizontalSpacing)-y.horizontalSpacing,w.currentArea.right=(w.currentArea.col+1)*(y.cellWidth+y.horizontalSpacing),w.currentArea.top=w.currentArea.row*(y.cellHeight+y.verticalSpacing)-y.verticalSpacing,w.currentArea.bottom=(w.currentArea.row+1)*(y.cellHeight+y.verticalSpacing),v())}function o(t,a){var l=e(this);C.css({width:l.css("width"),height:l.css("height"),top:l.css("top"),left:l.css("left")}),l.closest("div").append(C),C.fadeIn(300),l.data("vlsGfMetroW")?w.metroSize.width=parseInt(l.data("vlsGfMetroW")):w.metroSize.width=1,w.originalState.width=w.metroSize.width,l.data("vlsGfMetroH")?w.metroSize.height=parseInt(l.data("vlsGfMetroH")):w.metroSize.height=1,w.originalState.height=w.metroSize.height,l.data("vlsGfCol")?w.originalState.col=parseInt(l.data("vlsGfCol")):w.originalState.col=0,l.data("vlsGfRow")?w.originalState.row=parseInt(l.data("vlsGfRow")):w.originalState.row=0,w.centerShift={x:Math.ceil(y.cellWidth/2),y:Math.ceil(y.cellHeight/2)},w.position={x:a.position.left,y:a.position.top},w.editedItem=l,u(),d(t,a)}function d(e,t){var a=Math.floor(.2*y.cellWidth),l=Math.floor(.2*y.cellHeight),s=Math.floor((t.size.width-a)/(y.cellWidth+y.horizontalSpacing))+1,i=Math.floor((t.size.height-l)/(y.cellHeight+y.verticalSpacing))+1;(s!==w.metroSize.width||i!==w.metroSize.height)&&(w.metroSize.width=s,w.metroSize.height=i,t.originalPosition.left===t.position.left?w.currentArea.col=w.originalState.col:w.currentArea.col=w.originalState.col+w.originalState.width-s,t.originalPosition.top===t.position.top?w.currentArea.row=w.originalState.row:w.currentArea.row=w.originalState.row+w.originalState.height-i,v())}function f(t,a){C.fadeOut(500,function(){e(this).detach()}),w.editedItem=null,u(),v()}function v(){switch(S.layoutType){case"metro":g(S);break;case"grid":c(S)}}function g(){var t,a,l,s,n=w.itemsList,r=0,o=0,d=[],f={row:0,col:0},v={row:0,col:0},g=0;if(w.editedItem){if(w.currentArea.col+w.metroSize.width>S.columnCount)return;for(a=0;a<w.metroSize.width;++a)for(l=0;l<w.metroSize.height;++l)d.push(i(w.currentArea.col+a,w.currentArea.row+l));for(s=!1;!s;)e.inArray(i(f.col,f.row),d)<0?s=!0:(++f.col,f.col>=S.columnCount&&(f.col=0,++f.row));C.css({width:w.metroSize.width*(y.cellWidth+y.horizontalSpacing)-y.horizontalSpacing+"px",height:w.metroSize.height*(y.cellHeight+y.verticalSpacing)-y.verticalSpacing+"px",left:w.currentArea.col*(y.cellWidth+y.horizontalSpacing)+"px",top:w.currentArea.row*(y.cellHeight+y.verticalSpacing)+"px"}),w.editedItem.data("vlsGfCol",w.currentArea.col),w.editedItem.data("vlsGfRow",w.currentArea.row),w.editedItem.data("vlsGfMetroW",w.metroSize.width),w.editedItem.attr("data-vls-gf-metro-w",w.metroSize.width),w.editedItem.data("vlsGfMetroH",w.metroSize.height),w.editedItem.attr("data-vls-gf-metro-h",w.metroSize.height),g<w.currentArea.row+w.metroSize.height-1&&(g=w.currentArea.row+w.metroSize.height-1)}for(t=0;t<n.length;++t){var c=n[t];for(c.width>S.columnCount&&(c.width=S.columnCount),s=!1,v={col:f.col,row:f.row};!s;){for(s=!0,a=0;a<c.width;++a)for(l=0;l<c.height;++l)(v.col+a>=S.columnCount||e.inArray(i(v.col+a,v.row+l),d)>=0)&&(s=!1);s||(++v.col,v.col>=S.columnCount&&(v.col=0,++v.row))}for(a=0;a<c.width;++a)for(l=0;l<c.height;++l)d.push(i(v.col+a,v.row+l));for(r=(y.cellWidth+y.horizontalSpacing)*v.col,o=(y.cellHeight+y.verticalSpacing)*v.row,c.element.css("width",c.width*y.cellWidth+(c.width-1)*y.horizontalSpacing+"px").css("height",c.height*y.cellHeight+(c.height-1)*y.verticalSpacing+"px").css("top",o+"px").css("left",r+"px"),c.element.data("vlsGfCol",v.col),c.element.data("vlsGfRow",v.row),g<v.row+c.height-1&&(g=v.row+c.height-1),s=!1;!s;)e.inArray(i(f.col,f.row),d)<0?s=!0:(++f.col,f.col>=S.columnCount&&(f.col=0,++f.row))}b.find("ul").css("height",(g+1)*y.cellHeight+g*y.verticalSpacing)}function c(){var t,a=[],l=0,s=0,i={row:0,col:0},n=0;for(b.find("li").css("width",y.cellWidth+"px").css("height",y.cellHeight+"px").each(function(){var t=e(this),l=0,s=0,i=0;w.editedItem&&(t.hasClass("ui-draggable-dragging")||t.hasClass("ui-resizable-resizing"))||(t.data("vlsGfCol")&&(l=parseInt(t.data("vlsGfCol"))),t.data("vlsGfRow")&&(s=parseInt(t.data("vlsGfRow"))),t.data("vlsGfLinkId")&&(i=parseInt(t.data("vlsGfLinkId"))),a.push({element:t,row:s,col:l,linkId:i}))}),a.sort(function(e,t){return 100*e.row+e.col-100*t.row-t.col}),w.editedItem&&(C.css({left:w.currentArea.col*(y.cellWidth+y.horizontalSpacing)+"px",top:w.currentArea.row*(y.cellHeight+y.verticalSpacing)+"px"}),w.editedItem.data("vlsGfCol",w.currentArea.col),w.editedItem.data("vlsGfRow",w.currentArea.row),n<w.currentArea.row&&(n=w.currentArea.row)),i.row=0,i.col=0,t=0;t<a.length;++t){var r=a[t];w.editedItem&&w.currentArea.col==i.col&&w.currentArea.row==i.row&&(++i.col,i.col>=S.columnCount&&(i.col=0,++i.row)),l=(y.cellWidth+y.horizontalSpacing)*i.col,s=(y.cellHeight+y.verticalSpacing)*i.row,r.element.css("top",s+"px").css("left",l+"px"),r.element.data("vlsGfCol",i.col).attr("data-vls-gf-col",i.col),r.element.data("vlsGfRow",i.row).attr("data-vls-gf-row",i.row),n<i.row&&(n=i.row),++i.col,i.col>=S.columnCount&&(i.col=0,++i.row)}b.find("ul").css("height",(n+1)*y.cellHeight+n*y.verticalSpacing)}function p(){var t=e(this);if(!t.hasClass("vls-gf-processing")){t.addClass("vls-gf-processing");var a={layout_type:S.layoutType,column_count:S.columnCount,aspect_ratio:S.aspectRatio,horizontal_spacing:S.horizontalSpacing,vertical_spacing:S.verticalSpacing},l=[];b.find("li").each(function(){var t=e(this);l.push({link_id:t.data("vlsGfLinkId"),col:t.data("vlsGfCol"),row:t.data("vlsGfRow"),metro_w:t.data("vlsGfMetroW"),metro_h:t.data("vlsGfMetroH")})}),e.post(ajaxurl,{action:"vls_gf_update_album_layout",security:vlsGfGalleryAdminData.nonce,album_id:h,options:JSON.stringify(a),images:JSON.stringify(l)},function(a){t.removeClass("vls-gf-processing"),e(".vls-gf-update-feedback").show().fadeOut(3e3)})}}function u(){var t=[];b.find("li").each(function(){var a=e(this),l=0,s=0,i=1,n=1;w.editedItem&&(a.hasClass("ui-draggable-dragging")||a.hasClass("ui-resizable-resizing"))||(a.data("vlsGfCol")&&(l=parseInt(a.data("vlsGfCol"))),a.data("vlsGfRow")&&(s=parseInt(a.data("vlsGfRow"))),a.data("vlsGfMetroW")&&(i=parseInt(a.data("vlsGfMetroW"))),a.data("vlsGfMetroH")&&(n=parseInt(a.data("vlsGfMetroH"))),t.push({element:a,row:s,col:l,width:i,height:n}))}),t.sort(function(e,t){return 100*e.row+e.col-100*t.row-t.col}),w.itemsList=t}var h,m,b,G,w={editedItem:null,metroSize:{width:1,height:1},centerShift:{x:0,y:0},originalState:{width:1,height:1,col:0,row:0},position:{x:0,y:0},currentArea:{col:0,row:0,left:0,right:0,top:0,bottom:0},itemsList:[]},y={viewportWidth:0,zoom:1,cellWidth:0,cellHeight:0,horizontalSpacing:0,verticalSpacing:0},S={layoutType:"",columnCount:0,aspectRatio:1,horizontalSpacing:0,verticalSpacing:0},C=e('<div class="vls-gf-dragging-placeholder"></div>');return{loadContent:t}}(jQuery),VLS_GF.ItemEditPanelModule=function(e){function t(t,l){s=l,e.getJSON(ajaxurl,{action:"vls_gf_view_gallery_item_edit",item_type:t,item_id:l,tour:VLS_GF.TourModule&&VLS_GF.TourModule.isActive()},a)}function a(t){e(".vls-gf-tab-view").empty().append(t.view),
e("#vls-gf-item-details button.button-primary").on("click.vls-gf",l)}function l(t){t.preventDefault();var a=e("#vls-gf-item-details"),l=a.find("button.button-primary");if(!l.hasClass("disabled")){l.addClass("disabled"),a.find(".vls-gf-update-feedback").hide();var s={action:"vls_gf_update_album_details"};a.find("input, select, textarea").each(function(){s[this.name]=this.value}),e.post(ajaxurl,s,function(){l.removeClass("disabled"),a.find(".vls-gf-update-feedback").show().fadeOut(3e3)})}}var s;return{loadContent:t}}(jQuery),VLS_GF.ImageDetailsModule=function(e){function t(t,i,n,o){var d=e('<div class="vls-gf-modal"><div class="vls-gf-backdrop"></div><div class="vls-gf-image-details-dialog"></div></div>');d.data("vlsGfImages",n).data("vlsGfLinks",o).data("vlsGfCurrentImage",t),e("#wpwrap").append(d),f=d.find(".vls-gf-image-details-dialog");var v=e("<div />").addClass("vls-gf-title").append(e("<span/>").text(vlsGfGalleryAdminData.l10n.strImageDetails));f.append(v);var g=e("<div />").addClass("vls-gf-window-controls");v.append(g);var c=e("<button/>").addClass("vls-gf-btn-prev").text("<");c.on("click.vls-gf",a),g.append(c);var p=e("<button/>").addClass("vls-gf-btn-next").text(">");p.on("click.vls-gf",l),g.append(p);var u=e("<button/>").addClass("vls-gf-btn-cancel").text("Ã—");u.on("click.vls-gf",r),g.append(u),f.append('<div class="vls-gf-content"></div>'),s(t,i)}function a(){var t=e(this).closest(".vls-gf-modal");if(t.hasClass("vls-gf-busy"))return!1;var a=t.data("vlsGfImages"),l=t.data("vlsGfLinks"),i=t.data("vlsGfCurrentImage"),n=a.indexOf(i);n>0&&(n--,t.data("vlsGfCurrentImage",a[n]),s(a[n],l[n]))}function l(){var t=e(this).closest(".vls-gf-modal");if(t.hasClass("vls-gf-busy"))return!1;var a=t.data("vlsGfImages"),l=t.data("vlsGfLinks"),i=t.data("vlsGfCurrentImage"),n=a.indexOf(i);n<a.length-1&&(n++,t.data("vlsGfCurrentImage",a[n]),s(a[n],l[n]))}function s(t,a){f.addClass("vls-gf-busy"),e.getJSON(ajaxurl,{action:"vls_gf_view_image_details",image_id:t,link_id:a},function(e){i(e),f.removeClass("vls-gf-busy")})}function i(t){f.find(".vls-gf-content").empty().append(t.view),v=f.find(".vls-gf-image-panel .vls-gf-image-edit-overlay");var a=v.find(".vls-gf-crop-mask");c.top=parseFloat(a.data("vlsGfTop")?a.data("vlsGfTop"):0),c.right=parseFloat(a.data("vlsGfRight")?a.data("vlsGfRight"):0),c.bottom=parseFloat(a.data("vlsGfBottom")?a.data("vlsGfBottom"):0),c.left=parseFloat(a.data("vlsGfLeft")?a.data("vlsGfLeft"):0),a.resizable({containment:v,handles:"all",autoHide:!1,minHeight:43,minWidth:43,stop:function(e,t){d()}}),a.draggable({containment:v,distance:2,addClasses:!1,cursor:"move",stop:function(e,t){d()}}),e(window).on("resize.vls-gf-image-details",function(t){return e(t.target).hasClass("ui-resizable")||o(),!1}),f.find(".vls-gf-options-panel input.button-primary").on("click.vls-gf",n)}function n(){var t=f.find(".vls-gf-options-panel input.button-primary");if(!t.hasClass("vls-gf-busy")){t.addClass("vls-gf-busy");var a={action:"vls_gf_update_image_details",crop_top:c.top,crop_right:c.right,crop_bottom:c.bottom,crop_left:c.left};f.find("form input, form select, form textarea").each(function(){this.name&&(a[this.name]=this.value)}),e.post(ajaxurl,a,function(e){t.removeClass("vls-gf-busy"),f.find(".vls-gf-update-feedback").show().fadeOut(3e3)})}}function r(){e(window).off("resize.vls-gf-image-details");var t=e(".vls-gf-modal");t.find(".ui-resizable").resizable("destroy").draggable("destroy"),t.remove(),p&&VLS_GF.GalleryManager.reloadTab()}function o(){var t=e(".vls-gf-image-details-dialog .vls-gf-image-panel img"),a=e(".vls-gf-image-details-dialog .vls-gf-image-panel .vls-gf-image-edit-overlay");g.width=t.width(),g.height=t.height(),a.css({width:g.width,height:g.height});var l=a.find(".vls-gf-crop-mask");l.css({top:Math.round(g.height*c.top*.01)+"px",left:Math.round(g.width*c.left*.01)+"px",width:Math.round(g.width-g.width*c.left*.01-g.width*c.right*.01)+"px",height:Math.round(g.height-g.height*c.top*.01-g.height*c.bottom*.01)+"px"})}function d(){var t=e(".vls-gf-image-details-dialog .vls-gf-image-panel .vls-gf-crop-mask"),a=t.position(),l=t.width(),s=t.height();c.top=a.top/g.height*100,c.right=(g.width-a.left-l)/g.width*100,c.bottom=(g.height-a.top-s)/g.height*100,c.left=a.left/g.width*100,p=!0}var f,v,g={width:0,height:0},c={top:0,right:0,bottom:0,left:0},p=!1;return{showImageDetailsDialog:t,updateOverlaySize:o}}(jQuery),jQuery(document).ready(function(){VLS_GF.TourModule&&VLS_GF.TourModule.start(),VLS_GF.GalleryManager.init()});